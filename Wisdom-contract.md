# 十二、可编程验证规则
## 12.1 规则类型
&#160;&#160;&#160;&#160;&#160;&#160;由于公链中的程序功能是明确指定的，严格定义格式，因此这里的程序组成实际上更多的是一种模板的格式定义，而功能是明确的。

&#160;&#160;&#160;&#160;&#160;&#160;共支持5种规则定义：

&#160;&#160;&#160;&#160;&#160;&#160;1、资产定义-ASSET

&#160;&#160;&#160;&#160;&#160;&#160;2、多重签名-MULTISIGN

&#160;&#160;&#160;&#160;&#160;&#160;3、哈希时间锁定支付-HASHTIMELOCK

&#160;&#160;&#160;&#160;&#160;&#160;4、哈希高度锁定支付-HASHHEIGHTLOCK
## 12.2 规则部署
&#160;&#160;&#160;&#160;&#160;&#160;以上规则类型都拥有固定的规则定义格式，节点核心在源码一级硬编码支持，因此，用户实际上只需要填充自己的属性值和规则中的动态的值。

&#160;&#160;&#160;&#160;&#160;&#160;部署规则的过程也就是将用户自己的规则写入到区块，是通过一条特殊的事务来完成的，使用事务格式如下

|编号 |字段名|作用|类型
|:----:|:----:|:----:|:----:|
|1| version|事务版本|1字节|
|2| txHash|事务哈希|32字节 SHA3-256
|3|type|事务类型|1字节
|4|nonce|防止重放攻击|无符号64位
|5|from|签发者公钥|32字节
|6|gasPrice|手续费单价，实际的手续费是单价乘以Gas值|无符号64位
|7|amount|填0|无符号64位
|8|signature|签发者签名|byte[]
|9|to|全部填0|20字节 Hash160
|10|payloadLen|字节长度|4字节
|11|payload|字节格式的规则程序|byte[]

&#160;&#160;&#160;&#160;&#160;&#160;<font color=red>注意第9项To,部署时填写0</font>

&#160;&#160;&#160;&#160;&#160;&#160;事务写入到区块账本后，对应的事务哈希，可以根据地址的生成逻辑，返回一个地址，这个地址相当于就是合约地址。通过这种方式，合约地址就与账户地址一样，是在一个统一的账户模型中。

&#160;&#160;&#160;&#160;&#160;&#160;为了区分合约地址与普通账户地址，合约地址前缀设定为大写的WR两个字符。
## 12.3 规则调用
&#160;&#160;&#160;&#160;&#160;&#160;每一种类型的规则中都会包含若干个规则语句，规则语句是可以在外部进行签名调用的，使用事务格式如下

编号 |字段名|作用|类型
:----:|:----:|:----:|:----:|
1| version|事务版本|1字节|
2| txHash|事务哈希|32字节 SHA3-256
3|type|事务类型|1字节
4|nonce|防止重放攻击|无符号64位
5|from|签发者公钥|32字节
6|gasPrice|手续费单价，实际的手续费是单价乘以Gas值|无符号64位
7|amount|填0|无符号64位
8|signature|签发者签名|byte[]
9|to|合约地址的160哈希值|20字节 Hash160
10|payloadLen|字节长度|4字节
11|payload|字节格式的调用规则|byte[]

&#160;&#160;&#160;&#160;&#160;&#160; <font color=red>注意第9项的合约地址，与规则部署中的说明是一致的</font>

## 12.4 资产定义
### 12.4.1 资产规则
语法格式

```json
{
    "ASSET_RULE":{
        "code":"wdcc",
        "offering":10000,
        "totalamount":10000,
        "create":"xxxx",
        "owner":"yyyy",
        "allowincrease":"0",
        "info":{}    //300字节/可为空
    }
}
```

&#160;&#160;&#160;&#160;&#160;&#160;以上为资产定义的规则程序，支持如下的规则函数调用：

|编号| 规则函数|备注
|:----:|---|:----:|
|1|```"changeowner":{ "newowner":"ddddd" }```|更换所有者公钥
|2|```"transfer":{ "from":"公钥", "to":"公钥哈希", "value":"50" }```|转发资产
|3|```"increased":{ "amount":500 }```|是否增发

## 12.4.2  规则属性
1、code，资产代码

&#160;&#160;&#160;&#160;&#160;&#160;测试要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、资产代码必须大于等于3个字符，且小于等于12个字符

&#160;&#160;&#160;&#160;&#160;&#160;2）、不能包含空格/软回车等特殊字符

&#160;&#160;&#160;&#160;&#160;&#160;3）、必须全部为英文字符

&#160;&#160;&#160;&#160;&#160;&#160;4）、字符必须全部为大写

&#160;&#160;&#160;&#160;&#160;&#160;5）、不能是WDC

&#160;&#160;&#160;&#160;&#160;&#160;6）、不能与已经存在的code发生重复冲突

&#160;&#160;&#160;&#160;&#160;&#160;字节长度：6

2、offering，初期发行额度

&#160;&#160;&#160;&#160;&#160;&#160;测试要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、必须是整数

&#160;&#160;&#160;&#160;&#160;&#160;2）、值域在long类型的范围内

&#160;&#160;&#160;&#160;&#160;&#160;3）、不能小于等于0

&#160;&#160;&#160;&#160;&#160;&#160;字节长度：8

3、totalamount，发行总量

&#160;&#160;&#160;&#160;&#160;&#160;测试要点:

&#160;&#160;&#160;&#160;&#160;&#160;1）、必须是整数

&#160;&#160;&#160;&#160;&#160;&#160;2）、值域在long类型的范围内

&#160;&#160;&#160;&#160;&#160;&#160;3）、不能小于等于0

&#160;&#160;&#160;&#160;&#160;&#160;4）、部署时默认与“初期发行额度”同

&#160;&#160;&#160;&#160;&#160;&#160;字节长度：8

4、create，规则创建者的公钥

5、owner，规则所有者的公钥哈希

6、allowincrease，是否允许增发 1表示允许，0表示不允许

7、精度默认保持与主链默认的精度一致，小数点最大为8位

## 12.4.3 通用校验
1）、调用某个规则函数时，需要确认对应的规则程序中是否包含此规则函数，防止错位调用，比如针对多签规则调用资产规则的函数

2）、规则函数的调用语法必须是合法的，不能包含多余内容

3）、调用数据也使用RLP编码

## 12.4.4 资产规则函数

|编号 | 规则函数|校验要点
|:----:|---|---|
|1|```"changeowner":{ "newowner":"ddddd" }```|1、必须由现有的owner签发事务才有效<br>2、newowner是目标地址对应的公钥哈希，且必须是合法公钥哈希<br>3、若newowner全为0，表明销毁owner <br>4、此数据使用RLP编码<br>5、调用成功后，更新规则程序的属性状态值，更新字段为owner,注意并不是删除替换原有的值，而是在新的区块中包含了新版本的值<br>6、更换所有者与增发的事务，不在同一个区块中一起打包<br>7、更换所有者不会导致账户中的余额发生变化<br>8、newOwner与原来的owner不能一致<br>9、ForkDB中如有同一资产两次更换所有者事务，第二条事务在打包时会被清除
|2| ```"transfer":{ "from":"公钥", "to":"公钥哈希", "value":50 }```|1、此规则调用不涉及到多签场景<br>2、from是指公钥<br>3、to是指目标地址的公钥哈希<br>4、vaule是转发金额，金额必须大于0，底层数据表示使用最小精度，是整数表示<br>5、value必须小于等于fron地址账户对应资产的余额<br>6、注意，此处的from部分，与整个事务的from部分必须保持一致<br>7、value必须在long范围内<br>8、调用成功后，更新from与to对应资产的余额
|3|```"increased":{ "amount":500 }```|1、规则合约中指定的owner才能签发增发事务<br>2、增发的金额必须大于0 <br>3、增发的金额必须是整数<br>4、增发的金额值域在long类型范围内<br>5、增发后，总金额值域必须在long类型范围内 <br>6、设定为允许增发才可以增发

&#160;&#160;&#160;&#160;&#160;&#160;注意一个隐形的调用，当资产定义规则部署时，会默认将期发行总额全部赋值给owner账户。

## 12.5 多重签名
&#160;&#160;&#160;&#160;&#160;&#160;多重签名，是为了防止单个私钥丢失，或者众筹模式下的应用的安全信任问题支持的模式是M-N,表示一个规则最多有M签名，但是同时有MN签名时可以进行签发（注意，MN须小于等于NM）

本规则支持的多重签名逻辑如下：

1）、签名没有顺序要求，只要达到相应的数量即可

2）、多签是一个规则

3）、多签既支持WDC，也支持其他资产

4）、多签地址与多签地址以及普通地址之间，可以任意转发

语法格式

```json
{
    "MULTISIGN_RULE":{
       "asset160hash":{
          "m":3,
          "n":2
       },
       "pubkeys":[],
       "signatures":[],
       "pubkeyhash":[]
    }
}
```

&#160;&#160;&#160;&#160;&#160;&#160;以上为多签的规则定义，支持如下的规则函数调用：

|编号 | 规则函数|备注
|:----:|---|:----:|
|1| ```"transfer":{ "origin":"m", "dest":"s", "from":[], "signatures":[], "to":"公钥哈希", "value":50, "pubkeyhashs":[] }```|多签转账

注意，如果是普通地址之间的转发，无论是WDC还是自定义资产，都不涉及对本规则程序的调用。只有涉及到多签场景到调用才会使用到本规则函数。

### 12.5.1  规则属性
1、asset160hash，是指资产的hash160值

&#160;&#160;&#160;&#160;&#160;&#160;校验要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、若是，此处全部填0

&#160;&#160;&#160;&#160;&#160;&#160;2）、若是自定义资产，则需校验区块中是否存在

&#160;&#160;&#160;&#160;&#160;&#160;3）、在一个区块中，不能同时包含资产定义以及对资产的多签定义

2、n，最少需要达到的签名数

&#160;&#160;&#160;&#160;&#160;&#160;校验要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、必须大于等于2

&#160;&#160;&#160;&#160;&#160;&#160;2）、必须小于等于2

&#160;&#160;&#160;&#160;&#160;&#160;3）、必须是整数

3、m，总计可以具备的签名数

&#160;&#160;&#160;&#160;&#160;&#160;校验要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、必须大于等于2

&#160;&#160;&#160;&#160;&#160;&#160;2）、必须小于等于8

&#160;&#160;&#160;&#160;&#160;&#160;3）、必须是整数

4、pubkeys，表示公钥数组

&#160;&#160;&#160;&#160;&#160;&#160;1）、部署规则时，一旦部署，不能更改数组中的公钥排列顺序

&#160;&#160;&#160;&#160;&#160;&#160;2）、进行多签时，不用遵守排列顺序

&#160;&#160;&#160;&#160;&#160;&#160;3）、使用未压缩公钥

&#160;&#160;&#160;&#160;&#160;&#160;4）、必须是合法公钥

5、amount，表示总额

&#160;&#160;&#160;&#160;&#160;&#160;1）、部署时为0

6、Pubkeyhashs，表示公钥哈希数组

&#160;&#160;&#160;&#160;&#160;&#160;
1）、必须是合法公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;
2）、必须和pubkeys保持对应的一致

&#160;&#160;&#160;&#160;&#160;&#160;
3）、部署规则时，一旦部署，不能更改数组中的公钥哈希排里顺序

&#160;&#160;&#160;&#160;&#160;&#160;
4）、进行多签时，不用遵守排列顺序，第一个元素必须与事务签发者保持一致

7、在构造事务时payload签名原文的nonce为构造事务from的当前nonce

### 12.5.2 多签规则函数

```json
{
  "transfer":{
　             "orign":"1",
           　  "dest":"0",
               "from":"[]",
               "signatures":[],
               "to":"公钥哈希",
　             "value":50,
　             "pubkeyhashs":[]
　           }
}    
```    
解释：

1）、origin

&#160;&#160;&#160;&#160;&#160;&#160;表示账户来源地址，１表示多签地址，０表示普通账户地址

２）、dest

&#160;&#160;&#160;&#160;&#160;&#160;表示目标账户类型，１表示多签地址，０表示普通账户地址 注意，origin与dest不能同时为0

3）、transfer中的origin与dest的设定，要与from/signatures/to相对应

&#160;&#160;&#160;&#160;&#160;&#160;I、若origin是0，则from中存放签发者的公钥，注意from是一个数组，即
便里面只放一个公钥，也是一个数组格式

&#160;&#160;&#160;&#160;&#160;&#160;II、若origin是1，则from中存放多签规则成员的公钥数组，signatures中
则为相应的签名数组，from中的公钥与signatures中的签名顺序一一对应，但不需要与规则定义中的顺序保持一致

4）、from

&#160;&#160;&#160;&#160;&#160;&#160;根据来源账户类型的不同有不同的定义：

&#160;&#160;&#160;&#160;&#160;&#160;I、来源是多签地址，则表示是部署的多签规则对应的“公钥”

&#160;&#160;&#160;&#160;&#160;&#160;II、来源是普通账户地址，则表示普通账户地址对应的公钥

&#160;&#160;&#160;&#160;&#160;&#160;III、以上两种情况都需要校验公钥的合法性以及存在性
注意，这是一个数组

5）、signatures[]

&#160;&#160;&#160;&#160;&#160;&#160;存储签名数组

&#160;&#160;&#160;&#160;&#160;&#160;I、若是单个地址签发到多签地址，则是一个签名

&#160;&#160;&#160;&#160;&#160;&#160;II、若是多签地址签发，则是多个签名（无顺序要求）

6）、多签规则的使用，只能是面向部署时定义的公钥账户范围，注意这里说的是签发转账时签名账户。

&#160;&#160;&#160;&#160;&#160;&#160;I、普通账户地址转多签，普通账户地址必须是定义在多签规则中的，只有从多签
转出才需要限定地址范围，必须属于多签规则的定义

&#160;&#160;&#160;&#160;&#160;&#160;II、多签转多签，两者之间没什么约束关系

&#160;&#160;&#160;&#160;&#160;&#160;III、多签转普通账户，两者之间没什么约束关系


7）、to

&#160;&#160;&#160;&#160;&#160;&#160;表示目的地址所对应的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;I、若目标地址是普通账户，则表示普通账户的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;II、若目标地址是多签账户，则表示多签规则的“公钥哈希”

&#160;&#160;&#160;&#160;&#160;&#160;III、以上两种情况都需要校验公钥的合法性以及存在性

8）、value,转账金额

&#160;&#160;&#160;&#160;&#160;&#160;I、不能为0
  
&#160;&#160;&#160;&#160;&#160;&#160;II、不能为负数

&#160;&#160;&#160;&#160;&#160;&#160;III、必须小于等于from指定账户的余额

&#160;&#160;&#160;&#160;&#160;&#160;IV、第3条，注意是校验对应资产的余额

9）、在构造事务时payload里的签名原文nonce为构造事务from的当前nonce

10）、pubkeyHash,表示公钥哈希组

&#160;&#160;&#160;&#160;&#160;&#160;I、必须是合法公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;II、必须和pubkeys保持对应的一致

&#160;&#160;&#160;&#160;&#160;&#160;III、部署规则时，一旦部署，不能更改数组中的公钥哈希排列顺序

&#160;&#160;&#160;&#160;&#160;&#160;IV、进行多签时，不用遵守排列顺序，第一个元素必须与事务签发者保持一致流程关键要点

&#160;&#160;&#160;&#160;&#160;&#160;1、当多签规则向其他地址转发时，可以由多签规则中定义 的任何一个账户先行发起签名，其他账户也进行签名，最终将签名完成的事务广播到节点等待打包即可。

&#160;&#160;&#160;&#160;&#160;&#160;2、尤其注意，构造规则函数调用的事务结构的时候，事务数据结构中的from与to的定义，与规则函数中的from以及to,并不总是一致的，情形如下：

|from类型| 普通|多签|多签|普通
|:----:|:----:|:----:|:----:|:----:
|<b>to类型</b>| <b>普通</b>|<b>多签</b>|<b>普通</b>|<b>普通</b>
|事务中的from | 普通地址的公钥以及签名数据|多签规则定义范围中的任意一个普通账户公钥和签名|多签规则定义范围中的任意一个普通账户公钥和签名|<font color=red>X</font>
|事务中的to|多签规则的“公钥哈希”|多签规则的“公钥哈希”|多签规则的“公钥哈希”|<font color=red>X</font>
|规则函数中的from|同"事务中的from"|公钥数组|公钥数组| <font color=red>X</font>
|规则函数中的to|同"事务中的to"|普通地址的公钥哈希|多签地址的“公钥哈希”|<font color=red>X</font>

&#160;&#160;&#160;&#160;&#160;&#160;3、多签调用后，状态值更新逻辑如下：

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;I、多签规则具备5个状态值，一旦定义，只有余额是可根据规则函数变更的；

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;II、多签规则代表的地址与普通地址之间互转时，各自的余额会发生变化；

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;III、注意，比如多签地址转普通地址，对于多签地址来说，变更的是多签规则
中的amount余额，与组成多签的具体的普通账户余额没有关系。

## 12.6 哈希锁定
&#160;&#160;&#160;&#160;&#160;&#160;当一笔支付需要满足到某个条件是时候才能被触发，称之为条件支付。＂哈希时间锁定＂就是一种条件，区块高度锁定支付也是一种支付。支付对于区块链来说，就是一种事务结构，验证通过并且入块后即资产发生转移，然而资产发生了转移不代表目的方就可以立即使用，在计算到自己的余额中时，会判断是否符合了条件。

### 12.6.1 哈希&时间锁定支付
#### 12.6.１.1 语法格式
```json
{
　　"HASHTIMELOCK_RULE":{
　　　　"asset160hash":[],
　　　　"pubkeyhash":[]
　　}
}
```
|编号| 规则函数|备注
|:----:|---|:----:|
|1|```"transfer"{ value":"50", ;"hashresult":"", "timestamp":"" }```|转发资产
|2|```"get":{ "transferhash":"", "origintext":"" }```|获得锁定资产

#### 　　12.6.１.2  规则属性
1、asset160hash，是指资产的hash160值

&#160;&#160;&#160;&#160;&#160;&#160;校验要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、若是，此处全部填0

&#160;&#160;&#160;&#160;&#160;&#160;2）、若是自定义资产，则需校验区块中是否存在

&#160;&#160;&#160;&#160;&#160;&#160;3）、在一个区块中，不能同时包含锁定规则部署以及对资产的转发事务

２、Pubkeyhashs，是指目标账户地址的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;1）、仅支持普通账户地址的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;2）、必须是合法的公钥哈希，比如长度为160位，可转化为正常前缀的地址

####  12.6.1.3 规则函数
|编号 | 规则函数|校验要点
|:----:|---|---|
|1|```"transfer"{ "value":"50", "hashresult":"", "timestamp":"" }```|1、校验发送方对应资产的余额是否足够  <br>2、金额必须是数字，并且符合精度 <br>3、事务数据的from部分表明是签发方  <br>4、规则的部署账户与签发账户可以不是同一个 <br>5、hashresult,是指某个原文的256哈希值 <br>&#160;&#160;&#160;&#160;&#160;&#160;1）、这是一个初始的值，部署规则的时候需要制定  <br>&#160;&#160;&#160;&#160;&#160;&#160;2）、需要校验是256位长度  <br>6、blockheight,是指定的高度 <br>&#160;&#160;&#160;&#160;&#160;&#160;1）、必须大于等于0并且是整数 <br>&#160;&#160;&#160;&#160;&#160;&#160;2）、可以指定比当前更大的高度 <br>&#160;&#160;&#160;&#160;&#160;&#160;3）、如果高度小于等于当前高度，表示转发后立即激活 <br>&#160;&#160;&#160;&#160;&#160;&#160;4）、大于等于指定高度时，解锁有效
|2|``` "get":{ "transferhash":"", "origintext":"" }```|1、transferhash是指签发事务的哈希 <br>2、origintext是指原文，用来验证是否能得到同样的哈希值 <br>3、哈希以及时间都验证成功后，更新目标账户地址余额 <br>4、当前区块的最小可能时间戳必须大于等于规则中的时间戳 <br>5、必须是规则部署中的pubkeyhash才可以签发get规则的事务

### 12.6.２哈希＆区块高度锁定支付
#### 12.6.２.1 语法格式
```json
{
    "HASHHEIGHTLOCK_RULE":{
       "asset160hash":[],
       "pubkeyhash":[]
    }
}
```
|编号| 规则函数|备注
|:----:|---|:----:|
|1|```"transfer"{ "value":"50", "hashresult":"", "blockheight":"" }```|转发资产
|2|```"get":{ "transferhash":"", "origintext":"" }``` |获得锁定资产　

#### 　　12.6.2.2  规则属性
1、asset160hash，是指资产的hash160值

&#160;&#160;&#160;&#160;&#160;&#160;校验要点：

&#160;&#160;&#160;&#160;&#160;&#160;1）、若是，此处全部填0

&#160;&#160;&#160;&#160;&#160;&#160;2）、若是自定义资产，则需校验区块中是否存在

&#160;&#160;&#160;&#160;&#160;&#160;3）、在一个区块中，不能同时包含锁定规则部署以及对资产的转发事务

２、Pubkeyhashs，是指目标账户地址的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;1）、仅支持普通账户地址的公钥哈希

&#160;&#160;&#160;&#160;&#160;&#160;2）、必须是合法的公钥哈希，比如长度为160位，可转化为正常前缀的地址

####  12.6.2.3 规则函数
|编号 | 规则函数|校验要点
|:----:|---|---|
|1|```"transfer"{ "value":"50", "hashresult":"", "blockheight":"" }```|1、校验发送方对应资产的余额是否足够 <br>2、金额必须是数字，并且符合精度 <br>3、事务数据的from部分表明是签发方  <br>4、规则的部署账户与签发账户可以不是同一个 <br>5、hashresult,是指某个原文的256哈希值 <br>1）、这是一个初始的值，部署规则的时候需要制定  <br>2）、需要校验是256位长度  <br>6、blockheight,是指定的高度 <br>1）、必须大于等于0并且是整数 <br>2）、可以指定比当前更大的高度 <br>3）、如果高度小于等于当前高度，表示转发后立即激活 <br>4）、大于等于指定高度时，解锁有效
|2|```"get":{ "transferhash":"","origintext":"" }```|1、transferhash是指签发事务的哈希 <br>2、origintext是指原文，用来验证是否能得到同样的哈希值 <br>3、哈希以及时间都验证成功后，更新目标账户地址余额 <br>4、当前区块的最小可能时间戳必须大于等于规则中的时间戳 <br>5、必须是规则部署中的pubkeyhash才可以签发get规则的事务

